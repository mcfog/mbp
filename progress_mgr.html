<!DOCTYPE HTML>
<html lang="zh-CN">
<head>
	<title></title>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="popup.css" media="all" />
	<link rel="stylesheet" type="text/css" href="progress_mgr.css" media="all" />
	<script type="text/javascript" src="common.js"></script>
	<script type="text/javascript">
		$(function() {
			var PRG = {};
			BG.cacheGet(S.domain, function(o)
			{
				var $hp = BG.$(o);
				$hp.find('#prgSubjectList li').each(function()
				{
					var $a = $(this).find('a[subject_id]:last');
					var id = $a.attr('subject_id');
					var prg = PRG[id] = {
						ep:{},
						id:id,
						title:$a.attr('title'),
						count:{all:0,done:0,air:0},
						cover:$(this).find('img.grid').attr('src').replace(/((.+)\/cover\/g)/, '')
					};
					$hp.find('.prg_list a[subject_id='+id+']').each(function()
					{
						var $this = $(this), epid = parseInt($this.attr('id').split('_')[1]),
							onair = true,done = false, 
							$prg=$hp.find('#prginfo_'+epid);

						prg.count.all++;
						if($this.is('.epBtnWatched')) {
							prg.count.done++;
							done = true;
						}
						if(!$this.is('.epBtnNA,.epBtnToday')) {//如果没上映的就被抛弃/想看了会出Bug，暂时不解决
							prg.count.air++;
						} else {
							onair = false;
						}

						var airDate = /首播:([\d-]+)/.exec($prg.find('.tip').html());
						if(airDate) airDate = airDate[1];

						prg.ep[parseInt($this.text(),10)] = {
							id:epid,
							title:$this.attr('title'),
							onair:onair,
							done:done,
							airDate:airDate ? new Date(airDate) : false
						};
					});
					var $div = $('<div>');
					$div.appendTo('#container');
					$div.render($('#tmpl_bgm'), prg);
				});//prgli.each1
			}, {
				expire:900//i hate wating!
			});
//			$.each(PRG, function(k,prg)
//			{
//			});
			
			
			$(document.body).delegate('.bgm .panel .past', 'mouseenter', function() {
				var $this = $(this);
				var $prg = $this.parent();
				$prg.find('.now .epinfo').stop(true, true).fadeTo('fast', 0);
				$prg.find('.now').stop(true, true).delay(200).animate({
					width:24,
					left:111,
				});
				$this.stop(true, true).animate({
					width:130,
				}, function() {
					$this.find('.hide').show();
				})
			}).delegate('.bgm .panel .past', 'mouseleave', function() {
				var $this = $(this);
				var $prg = $this.parent();
				$prg.find('.now .epinfo').stop(true, true).delay(200).fadeTo('fast', 1);
				$prg.find('.now').stop(true, true).animate({
					width:120,
					left:15,
				})
				$this.find('.hide').hide();
				$this.stop(true, true).animate({
					width:38,
				})
			});

			$(document.body).delegate('.bgm .panel .future', 'mouseenter', function() {
				var $this = $(this);
				var $prg = $this.parent();
				$prg.find('.now .epinfo').fadeOut('fast');
				$prg.find('.now').delay(200).animate({
					width:34,
				});
				$this.animate({
					width:110,
				}, function() {
					$this.find('.hide').show();
				})
			}).delegate('.bgm .panel .future', 'mouseleave', function() {
				var $this = $(this);
				var $prg = $this.parent();
				$prg.find('.now .epinfo').delay(200).fadeIn('fast');
				$prg.find('.now').animate({
					width:120,
				});
				$this.find('.hide').hide();
				$this.stop(true, true).animate({
					width:38,
				})
			}).delegate('.bgm .panel .epbox li, .epinfo a.title', 'click', function()
			{
				var $this = $(this), id = $this.closest('*[subject_id]').attr('subject_id'),
					num = $this.closest('*[_num]').attr('_num'), epid = PRG[id].ep[num].id;
				window.open(S.domain+'/ep/'+epid);
			}).delegate('.bgm .panel .epinfo .done-button', 'click', function()
			{
				var $this = $(this), id = $this.closest('*[subject_id]').attr('subject_id'),
					num = $this.closest('*[_num]').attr('_num'), epid = PRG[id].ep[num].id;
				
				EXT.sendRequest({
					do:'injectAjax',
					options:{
						url:'/subject/ep/'+epid+'/status/watched?ajax=1',
						type:'POST',
						headers:{'Content-Type':'application/xml'}
					}
				}, function(res) {
					PRG[id].ep[num].done = true;
					PRG[id].count.done += 1;
					$('.bgm[subject_id='+id+']').parent().render($('#tmpl_bgm'), PRG[id]);
					BG.cacheGet(S.domain, false, {force:true});
					$(document.body).trigger('mbp-done', [epid]);
				});
			}).delegate('.bgm .panel .epinfo .discuss', 'click', function()
			{
				var $this = $(this), id = $this.closest('*[subject_id]').attr('subject_id'),
					num = $this.closest('*[_num]').attr('_num'), epid = PRG[id].ep[num].id;
				$(document.body).bind('mbp-done.'+epid, function(event, _epid) {
					if(epid!=_epid) return;
					$(document.body).unbind('mbp-done.'+epid);
					window.open(S.domain+'/ep/'+epid);
				})
			});
		});
	</script>
</head>
<body>
<div id="container"></div>
<script type="text/x-sjtp" id="tmpl_bgm">
	<<~
	setTimeout(function() {
		$container.find('.thumb img').squash(100,119);
	})>>
	<div class="bgm" subject_id="<<:id>>">
		<h3 title="<<:title>>">
			<a href="<<:S.domain>>/subject/<<:id>>" target="_blank"><<:title>></a>
		</h3>
		<div class="thumb">
			<img src="http://lain.bgm.tv/pic/cover/s<<:cover>>" alt="" />
		</div>
		<div class="panel">
			<div class="progress">
				<<~var nowNum=1;while(ep[nowNum] && ep[nowNum].done) nowNum+=1;>>
				<div class="past<<:nowNum==1?' hide':''>>">
					<div class="hide">
						<ul class="epbox">
							<<if nowNum > 11>>
								<li class="more">更早</li>
							<</if>>
							<<~for(var k=nowNum-10;k<nowNum;k++) {if(k<=0)continue;>>
								<<if k<10>>
									<li _num=<<:k>>>0<<:k>></li>
								<<elif k<100>>
									<li _num=<<:k>>><<:k>></li>
								<<else>>
									<li _num=<<:k>> class="small"><<:k>></li>
								<</if>>
							<<~}>>
						</ul>
					</div>
				</div>
				<div class="now">
					<div class="epinfo" _num=<<:nowNum>>>
					<<if count.done < count.all>>
						<a class="title" href="javascript:;">ep.<<:nowNum<10?"0"+nowNum:nowNum>></a>
						<<if ep[nowNum].onair>>
							<a class="button done-button">
								看过
								<div class="discuss" title="标记看过&打开讨论"></div>
							</a>
						<<else>>
							<a class="button unair-button">
								<<:ep[nowNum].airDate?ep[nowNum].airDate.format('yyyy-mm-dd'):"近期上映">>
							</a>
						<</if>>
					<<else>>
						<span class="title">Fin.</span>
						<a class="button done-button">
							看过
							<div class="discuss"></div>
						</a>
					<</if>>
					</div>
				</div>
				<div class="future<<:nowNum==count.all?' hide':''>>">					
					<div class="hide">
						<ul class="epbox">
							<<~for(var k=nowNum;k<=count.done+6;k++) {if(k>count.all) continue;>>
								<<if k<10>>
									<li _num=<<:k>>>0<<:k>></li>
								<<elif k<100>>
									<li _num=<<:k>>><<:k>></li>
								<<else>>
									<li _num=<<:k>> class="small"><<:k>></li>
								<</if>>
							<<~}>>
							<<if count.all - count.done > 7>>
								<li class="more">更晚</li>
							<</if>>
						</ul>
					</div>
				</div>
			</div>
			<div class="stat">
				<span class="all" title="总集数"><<:count.all>></span>
				<span class="air" title="已放映"><<:count.air>></span>
				<span class="done" title="已看过"><<:count.done>></span>
			</div>
		</div>
	</div>
</script>

</body>
</html>
